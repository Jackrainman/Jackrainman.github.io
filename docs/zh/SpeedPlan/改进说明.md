# ä»£ç Aæ”¹è¿›ä¸ºè½¨è¿¹è§„åˆ’çš„å®Œæ•´è¯´æ˜

## ğŸ“‹ æ”¹è¿›æ€»è§ˆ

### æ”¹è¿›å‰ï¼ˆchassis_calculations.cï¼‰
âŒ ç®€å•çš„é€Ÿåº¦é™å¹…å™¨ï¼Œä¸æ˜¯çœŸæ­£çš„è½¨è¿¹è§„åˆ’
âŒ æ²¡æœ‰é¢„è§„åˆ’ï¼Œæ— æ³•é¢„çŸ¥è¿åŠ¨æ—¶é—´
âŒ å­˜åœ¨é€Ÿåº¦çªå˜é—®é¢˜
âŒ å¯èƒ½æ— æ³•å‡†ç¡®åœåœ¨ç›®æ ‡ä½ç½®

### æ”¹è¿›åï¼ˆchassis_calculations_improved.cï¼‰
âœ… å®Œæ•´çš„æ¢¯å½¢è½¨è¿¹è§„åˆ’
âœ… é¢„å…ˆè®¡ç®—æ€»æ—¶é—´å’Œè½¨è¿¹
âœ… é€Ÿåº¦è¿ç»­å¹³æ»‘
âœ… ç²¾ç¡®åˆ°è¾¾ç›®æ ‡ä½ç½®
âœ… è‡ªåŠ¨å¤„ç†ä¸‰è§’å½¢/æ¢¯å½¢è½¨è¿¹

---

## ğŸ”§ æ ¸å¿ƒæ”¹è¿›å†…å®¹

### 1. æ–°å¢æ•°æ®ç»“æ„

```c
// å•è½´è½¨è¿¹å‚æ•°ç»“æ„ä½“
typedef struct {
    // å½“å‰çŠ¶æ€
    float current_pos;      // å½“å‰ä½ç½®
    float current_speed;    // å½“å‰é€Ÿåº¦
    TrajectoryState state;  // è¿åŠ¨çŠ¶æ€ï¼ˆåŠ é€Ÿ/åŒ€é€Ÿ/å‡é€Ÿ/å®Œæˆï¼‰

    // ç›®æ ‡å‚æ•°
    float target_pos;       // ç›®æ ‡ä½ç½®
    float start_pos;        // èµ·å§‹ä½ç½®
    float max_speed;        // æœ€å¤§é€Ÿåº¦
    float max_accel;        // æœ€å¤§åŠ é€Ÿåº¦

    // è½¨è¿¹è§„åˆ’å‚æ•°ï¼ˆé¢„å…ˆè®¡ç®—ï¼‰
    float t_accel;          // åŠ é€Ÿæ—¶é—´
    float t_uniform;        // åŒ€é€Ÿæ—¶é—´
    float t_total;          // æ€»æ—¶é—´ â­ å…³é”®ï¼
    float p_accel;          // åŠ é€Ÿæ®µè·ç¦»
    float current_time;     // å½“å‰æ—¶é—´
    int direction;          // è¿åŠ¨æ–¹å‘
} AxisTrajectory;
```

### 2. æ ¸å¿ƒç®—æ³•æ”¹è¿›

#### â­ æ”¹è¿›ç‚¹1ï¼šè½¨è¿¹åˆå§‹åŒ–ï¼ˆé¢„è§„åˆ’ï¼‰

**åŸä»£ç é—®é¢˜**ï¼šæ²¡æœ‰é¢„è§„åˆ’ï¼Œæ¯æ¬¡åªè®¡ç®—å½“å‰å‘¨æœŸçš„é€Ÿåº¦å˜åŒ–

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```c
void axis_trajectory_init(AxisTrajectory *axis,
                         float current_pos,
                         float target_pos,
                         float max_speed,
                         float max_accel) {

    // 1. è®¡ç®—è·ç¦»å’Œæ–¹å‘
    float distance = target_pos - current_pos;
    float D = fabsf(distance);

    // 2. è®¡ç®—åŠ é€Ÿæ—¶é—´å’Œè·ç¦»
    axis->t_accel = max_speed / max_accel;
    axis->p_accel = 0.5f * max_accel * axis->t_accel * axis->t_accel;

    // 3. åˆ¤æ–­è½¨è¿¹ç±»å‹ï¼ˆå…³é”®æ”¹è¿›ï¼ï¼‰
    if (D < 2.0f * axis->p_accel) {
        // ä¸‰è§’å½¢ï¼šè·ç¦»å¤ªçŸ­ï¼Œè°ƒæ•´æœ€å¤§é€Ÿåº¦
        axis->max_speed = sqrtf(max_accel * D);
        axis->t_accel = axis->max_speed / max_accel;
        axis->t_uniform = 0.0f;
    } else {
        // æ¢¯å½¢ï¼šå¯ä»¥è¾¾åˆ°æœ€å¤§é€Ÿåº¦
        float p_uniform = D - 2.0f * axis->p_accel;
        axis->t_uniform = p_uniform / max_speed;
    }

    // 4. è®¡ç®—æ€»æ—¶é—´
    axis->t_total = 2.0f * axis->t_accel + axis->t_uniform;
}
```

#### â­ æ”¹è¿›ç‚¹2ï¼šè½¨è¿¹æ›´æ–°ï¼ˆæŒ‰é˜¶æ®µè®¡ç®—ï¼‰

**åŸä»£ç é—®é¢˜**ï¼š
```c
// chassis_calculations.c:62-70
if (diff > max_change) {
    *current_speed += max_change;  // âŒ åªåšé™å¹…
} else {
    *current_speed = target_speed; // âŒ çªå˜ï¼
}
```

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```c
int axis_trajectory_update(AxisTrajectory *axis, float dt) {
    axis->current_time += dt;

    if (t <= Ta) {
        // åŠ é€Ÿæ®µ
        axis->current_pos = start_pos + 0.5 * a * t^2;
        axis->current_speed = a * t;

    } else if (t <= Ta + Tv) {
        // åŒ€é€Ÿæ®µ
        axis->current_pos = start_pos + p_accel + v * (t - Ta);
        axis->current_speed = v;

    } else {
        // å‡é€Ÿæ®µï¼ˆä»ç»ˆç‚¹åç®—ï¼‰
        float T_rem = t_total - t;
        axis->current_pos = target_pos - 0.5 * a * T_rem^2;
        axis->current_speed = a * T_rem;
    }
}
```

---

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### æ–¹å¼1ï¼šç›´æ¥æ›¿æ¢ï¼ˆç®€å•ï¼‰

å¦‚æœä½ åªéœ€è¦æ¢¯å½¢è§„åˆ’ï¼Œç›´æ¥ç”¨æ”¹è¿›ç‰ˆæ›¿æ¢ï¼š

```c
// æ›¿æ¢ chassis_calculations.c å’Œ chassis_calculations.h
// ä¸º chassis_calculations_improved.c å’Œ chassis_calculations_improved.h

// ä½¿ç”¨æ–¹å¼å®Œå…¨ç›¸åŒ
float vx, vy, vw;
chassis_speed_plan(target_x, target_y, target_yaw, &vx, &vy, &vw);
```

### æ–¹å¼2ï¼šå…±å­˜ä½¿ç”¨ï¼ˆæ¨èï¼‰

ä¿ç•™åŸä»£ç ï¼Œæ–°å¢æ”¹è¿›ç‰ˆï¼š

```c
#include "chassis_calculations_improved.h"

// æ¯ä¸ªæ§åˆ¶å‘¨æœŸè°ƒç”¨
void control_loop(void) {
    // 1. è®¾ç½®ç›®æ ‡ä½ç½®
    float target_x = 100.0f;
    float target_y = 50.0f;
    float target_yaw = 1.57f;  // 90åº¦

    // 2. æ‰§è¡Œè½¨è¿¹è§„åˆ’
    improved_trajectory_plan(target_x, target_y, target_yaw);

    // 3. è·å–å½“å‰é€Ÿåº¦è¾“å‡º
    float vx, vy, vw;
    get_trajectory_output(&vx, &vy, &vw, NULL, NULL, NULL);

    // 4. å‘é€é€Ÿåº¦ç»™åº•å±‚æ§åˆ¶å™¨
    motor_control(vx, vy, vw);

    // 5. ï¼ˆå¯é€‰ï¼‰æ£€æŸ¥æ˜¯å¦å®Œæˆ
    if (is_trajectory_finished()) {
        // åˆ°è¾¾ç›®æ ‡ä½ç½®
        printf("è½¨è¿¹å®Œæˆ!\n");
    }
}
```

### æ–¹å¼3ï¼šè·å–è¯¦ç»†ä¿¡æ¯ï¼ˆè°ƒè¯•ï¼‰

```c
float vx, vy, vw;
float px, py, pyaw;
TrajectoryState state_x, state_y, state_w;

// è·å–é€Ÿåº¦å’Œä½ç½®
get_trajectory_output(&vx, &vy, &vw, &px, &py, &pyaw);

// è·å–çŠ¶æ€
get_trajectory_state(&state_x, &state_y, &state_w);

// æ‰“å°è°ƒè¯•ä¿¡æ¯
printf("Xè½´: ä½ç½®=%.2f, é€Ÿåº¦=%.2f, çŠ¶æ€=%d\n", px, vx, state_x);
// çŠ¶æ€: 0=ç©ºé—², 1=åŠ é€Ÿ, 2=åŒ€é€Ÿ, 3=å‡é€Ÿ, 4=å®Œæˆ
```

---

## âš™ï¸ å‚æ•°é…ç½®

### ä¿®æ”¹æœ€å¤§é€Ÿåº¦å’ŒåŠ é€Ÿåº¦

åœ¨ `chassis_calculations_improved.c` æ–‡ä»¶é¡¶éƒ¨ä¿®æ”¹ï¼š

```c
#define MAX_ACCEL_X 40.0f   // xæ–¹å‘æœ€å¤§åŠ é€Ÿåº¦ (å•ä½æ ¹æ®ä½ çš„ç³»ç»Ÿ)
#define MAX_ACCEL_Y 40.0f   // yæ–¹å‘æœ€å¤§åŠ é€Ÿåº¦
#define MAX_ACCEL_W 20.0f   // æ—‹è½¬æœ€å¤§è§’åŠ é€Ÿåº¦

#define MAX_SPEED_X 100.0f  // xæ–¹å‘æœ€å¤§é€Ÿåº¦
#define MAX_SPEED_Y 100.0f  // yæ–¹å‘æœ€å¤§é€Ÿåº¦
#define MAX_SPEED_W 50.0f   // æœ€å¤§è§’é€Ÿåº¦
```

### å¤„ç†ç›®æ ‡å˜åŒ–

ä»£ç å·²è‡ªåŠ¨å¤„ç†ç›®æ ‡å˜åŒ–ï¼š

```c
// å†…éƒ¨é€»è¾‘ï¼ˆå·²å®ç°ï¼‰
if (ç›®æ ‡æ”¹å˜) {
    // ä»å½“å‰ä½ç½®é‡æ–°è§„åˆ’åˆ°æ–°ç›®æ ‡
    axis_trajectory_init(å½“å‰ä½ç½®, æ–°ç›®æ ‡, ...);
}
```

---

## ğŸ” å¯¹æ¯”æµ‹è¯•ç¤ºä¾‹

### æµ‹è¯•åœºæ™¯ï¼šä»0ç§»åŠ¨åˆ°100ï¼Œæœ€å¤§é€Ÿåº¦50ï¼Œæœ€å¤§åŠ é€Ÿåº¦10

**åŸä»£ç Aè¿è¡Œç»“æœ**ï¼š
```
æ—¶é—´(s)  é€Ÿåº¦   ä½ç½®   é—®é¢˜
0.0      0      0
0.1      10     0.5    æ­£å¸¸åŠ é€Ÿ
0.2      20     2.0    æ­£å¸¸åŠ é€Ÿ
...
5.0      50     125    âŒ è¶…é€Ÿå¹¶å†²è¿‡ç›®æ ‡ï¼
5.1      50     130    âŒ å·²ç»è¶…è¿‡100
```

**æ”¹è¿›ä»£ç è¿è¡Œç»“æœ**ï¼š
```
é˜¶æ®µåˆ¤æ–­ï¼š
- åŠ é€Ÿæ—¶é—´ Ta = 50/10 = 5s
- åŠ é€Ÿè·ç¦» Pa = 0.5*10*5^2 = 125
- æ€»è·ç¦» D = 100
- D < 2*Paï¼Œåˆ¤æ–­ä¸ºä¸‰è§’å½¢è½¨è¿¹
- è°ƒæ•´æœ€å¤§é€Ÿåº¦ v = sqrt(10*100) = 31.6
- æ–°åŠ é€Ÿæ—¶é—´ Ta = 31.6/10 = 3.16s
- æ€»æ—¶é—´ = 2*3.16 = 6.32s

æ—¶é—´(s)  é€Ÿåº¦   ä½ç½®   é˜¶æ®µ
0.0      0      0      åŠ é€Ÿ
1.0      10     5      åŠ é€Ÿ
2.0      20     20     åŠ é€Ÿ
3.16     31.6   50     åŠ é€Ÿç»“æŸï¼ˆåˆšå¥½ä¸€åŠï¼‰
4.0      21.6   80     å‡é€Ÿ
5.0      11.6   95     å‡é€Ÿ
6.32     0      100    âœ… å®Œæˆï¼ç²¾ç¡®åˆ°è¾¾
```

---

## ğŸ“Š å…³é”®æ”¹è¿›å¯¹æ¯”è¡¨

| ç‰¹æ€§ | åŸä»£ç A | æ”¹è¿›ä»£ç  |
|------|---------|----------|
| ç®—æ³•ç±»å‹ | é€Ÿåº¦é™å¹…å™¨ | å®Œæ•´è½¨è¿¹è§„åˆ’ |
| é¢„è§„åˆ’ | âŒ æ—  | âœ… æœ‰ï¼ˆåˆå§‹åŒ–æ—¶è®¡ç®—ï¼‰ |
| çŠ¶æ€æœº | âŒ æ—  | âœ… 4çŠ¶æ€ï¼ˆåŠ é€Ÿ/åŒ€é€Ÿ/å‡é€Ÿ/å®Œæˆï¼‰ |
| ä¸‰è§’å½¢è½¨è¿¹ | âŒ ä¸æ”¯æŒ | âœ… è‡ªåŠ¨åˆ¤æ–­å’Œå¤„ç† |
| é€Ÿåº¦è¿ç»­æ€§ | âŒ æœ‰çªå˜ | âœ… å®Œå…¨è¿ç»­ |
| ä½ç½®ç²¾åº¦ | âŒ ä½ï¼ˆå¯èƒ½å†²è¿‡ï¼‰ | âœ… é«˜ï¼ˆç²¾ç¡®åˆ°è¾¾ï¼‰ |
| æ€»æ—¶é—´é¢„æµ‹ | âŒ ä¸å¯é¢„æµ‹ | âœ… å¯é¢„æµ‹ï¼ˆt_totalï¼‰ |
| è°ƒè¯•å‹å¥½åº¦ | âš ï¸ ä¸€èˆ¬ | âœ… é«˜ï¼ˆçŠ¶æ€å¯æŸ¥ï¼‰ |

---

## ğŸ¯ é€‚ç”¨åœºæ™¯

### æ¨èä½¿ç”¨æ”¹è¿›ä»£ç çš„åœºæ™¯
- âœ… æœºå™¨äººè·¯å¾„è·Ÿè¸ªï¼ˆéœ€è¦ç²¾ç¡®ä½ç½®ï¼‰
- âœ… äº‘å°æ§åˆ¶ï¼ˆéœ€è¦å¹³æ»‘è¿åŠ¨ï¼‰
- âœ… AGVå¯¼èˆªï¼ˆéœ€è¦å‡†ç¡®åœæ­¢ï¼‰
- âœ… æœºæ¢°è‡‚è¿åŠ¨ï¼ˆéœ€è¦å¯é¢„æµ‹è½¨è¿¹ï¼‰
- âœ… ä»»ä½•éœ€è¦ç²¾ç¡®æ§åˆ¶çš„åœºæ™¯

### åŸä»£ç Aé€‚ç”¨çš„åœºæ™¯
- âš ï¸ çº¯é€Ÿåº¦è·Ÿè¸ªï¼ˆä¸å…³å¿ƒä½ç½®ï¼‰
- âš ï¸ å®æ—¶å“åº”ä¼˜å…ˆï¼ˆå¯å®¹å¿è¯¯å·®ï¼‰
- âš ï¸ è®¡ç®—èµ„æºæå…¶å—é™çš„åœºæ™¯

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¾“å…¥å‚æ•°ä»"é€Ÿåº¦"æ”¹ä¸º"ä½ç½®"ï¼Ÿ
A: çœŸæ­£çš„è½¨è¿¹è§„åˆ’éœ€è¦çŸ¥é“**ç›®æ ‡ä½ç½®**æ‰èƒ½è®¡ç®—å‡é€Ÿç‚¹ã€‚å¦‚æœåªçŸ¥é“ç›®æ ‡é€Ÿåº¦ï¼Œæ— æ³•ä¿è¯å‡†ç¡®åœæ­¢ã€‚

### Q2: å¦‚æœæˆ‘ä»ç„¶æƒ³è¾“å…¥é€Ÿåº¦æ€ä¹ˆåŠï¼Ÿ
A: å¯ä»¥é€šè¿‡ç§¯åˆ†è½¬æ¢ä¸ºä½ç½®ï¼š
```c
static float integrated_x = 0.0f;
integrated_x += target_velocity_x * dt;
improved_trajectory_plan(integrated_x, ...);
```

### Q3: æ€§èƒ½å¼€é”€å¢åŠ äº†å¤šå°‘ï¼Ÿ
A: æ¯ä¸ªå‘¨æœŸå¢åŠ çº¦ï¼š
- 3æ¬¡æµ®ç‚¹ä¹˜æ³•ï¼ˆè®¡ç®—ä½ç½®/é€Ÿåº¦ï¼‰
- 2-3æ¬¡æ¡ä»¶åˆ¤æ–­ï¼ˆé˜¶æ®µåˆ¤æ–­ï¼‰
- å¯¹äºåµŒå…¥å¼ç³»ç»Ÿå‡ ä¹å¯å¿½ç•¥

### Q4: å¦‚ä½•è°ƒè¯•è½¨è¿¹è§„åˆ’ï¼Ÿ
A: ä½¿ç”¨çŠ¶æ€æŸ¥è¯¢æ¥å£ï¼š
```c
TrajectoryState state;
get_trajectory_state(&state, NULL, NULL);
if (state == TRAJ_DECELERATING) {
    printf("æ­£åœ¨å‡é€Ÿï¼Œå³å°†åˆ°è¾¾ç›®æ ‡\n");
}
```

---

## ğŸ“ æ€»ç»“

æ”¹è¿›ä»£ç é€šè¿‡ä»¥ä¸‹æ ¸å¿ƒä¿®æ”¹å®ç°äº†çœŸæ­£çš„è½¨è¿¹è§„åˆ’ï¼š

1. **æ·»åŠ é¢„è§„åˆ’** - åˆå§‹åŒ–æ—¶è®¡ç®—æ€»æ—¶é—´å’Œè½¨è¿¹å‚æ•°
2. **æ·»åŠ çŠ¶æ€æœº** - åŒºåˆ†åŠ é€Ÿ/åŒ€é€Ÿ/å‡é€Ÿé˜¶æ®µ
3. **ä¸‰è§’å½¢åˆ¤æ–­** - è‡ªåŠ¨å¤„ç†çŸ­è·ç¦»è¿åŠ¨
4. **ç²¾ç¡®å‡é€Ÿ** - ä»ç»ˆç‚¹åç®—å‡é€Ÿæ®µ
5. **ä½ç½®é—­ç¯** - ä¿è¯å‡†ç¡®åˆ°è¾¾ç›®æ ‡

è¿™äº›æ”¹è¿›ä½¿ä»£ç ä»"é€Ÿåº¦é™å¹…å™¨"å‡çº§ä¸º"è½¨è¿¹ç”Ÿæˆå™¨"ï¼Œæ»¡è¶³é«˜ç²¾åº¦æ§åˆ¶éœ€æ±‚ã€‚
